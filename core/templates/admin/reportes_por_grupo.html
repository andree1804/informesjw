{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<div id="content-main">
    {{ block.super }}
  <!-- Formulario de filtros: Grupo, Mes y Año -->
  <form method="get" class="form-inline">
  	<div style="display: flex; gap: 20px; align-items: center;">
      {{ form.year.label_tag }} {{ form.year }}
    </div>
    <div style="display: flex; gap: 20px; align-items: center;">
      {{ form.month.label_tag }} {{ form.month }}
      {{ form.group.label_tag }} {{ form.group }}
    </div>
    <input type="submit" class="default" value="Filtrar" style="margin-right: auto;display: block;">
    <input type="text" name="buscar" value="" placeholder="Buscar por apellido o nombre">
  </form>

  {% if persons %}
  <form method="post">
    {% csrf_token %}
	<div class="table-report" style="position: relative;">
	    <fieldset class="module aligned ">
		    <input type="hidden" name="total" value="{{ persons|length }}">
		    <table class="admin-table" style="width: 100%; margin-top: 20px;">
		      <thead>
		        <tr>
		          <th>Nombre</th>
		          <th>Privilegio</th>
		          <th>Horas</th>
		          <th>Cursos</th>
		          <th>Participó</th>
		        </tr>
		      </thead>
		      <tbody>
		      	<input type="hidden" name="group" value="{{ group }}">
				  	<input type="hidden" name="month" value="{{ month }}">
				  	<input type="hidden" name="year" value="{{ year }}">
		        {% for person in persons %}
		        <tr>
		          <td>
		            {{ person.names }}
		            <input type="hidden" name="person_{{ forloop.counter0 }}" value="{{ person.id }}">
		          </td>
		          <td>
		            <select name="privilege_{{ forloop.counter0 }}">
					  {% for priv in privilegios %}
					    <option value="{{ priv.id }}" {% if priv.id == person.privilege.id %}selected{% endif %}>
					      {{ priv.name }}
					    </option>

					    {{person.privilege.id}}
					  {% endfor %}
					</select>
		          </td>
		          <td><input type="number" readonly name="hours_{{ forloop.counter0 }}" 
						       value="{% if person.existing_report.hours != 0 %}{{ person.existing_report.hours }}{% endif %}" 
						       min="0"></td>
		          <td><input type="number" name="courses_{{ forloop.counter0 }}" 
		          		 value="{% if person.existing_report.courses != 0 %}{{ person.existing_report.courses }}{% endif %}" min="0">
		          </td>
		          <td style="position: relative;"><input type="checkbox" name="participated_{{ forloop.counter0 }}" {% if person.existing_report and person.existing_report.participated %}checked{% endif %}>
		          <a href="#" class="addlink addnote" aria-describedby="core-personvirtual">Agregar nota</a>
		          <div>
		          <input type="text" name="note_{{ forloop.counter0 }}" 
		          		 value="{% if person.existing_report.note and person.existing_report.note != 'None' %}{{ person.existing_report.note }}{% else %}{% endif %}" min="0"
		          		 class="hide_note hide_note_tooltip" placeholder="Agregar nota"></div>
		          </td>
		        </tr>
		        {% endfor %}
		      </tbody>
		    </table>
		</fieldset>
	    <!--<button type="submit" class="default" style="margin-top: 20px;">Guardar Reportes</button>-->
	    <div class="submit-row">
	    	<input type="submit" class="default" value="Guardar informe">
	    	{% if request.user.username == "admin" %}
		    	{% if month and year %}
				    <!--<a href="{% url 'admin:report_consolidated' %}?month={{ month }}&year={{ year }}&generate_report=1"
				       class="button">
				      Ver consolidado
				    </a>-->
				    {% if request.user.username == "admin" and month and year %}
						<a href="{% url 'admin:report_consolidated' %}?month={{ month }}&year={{ year }}&generate_report=1&format=pdf"
						   class="button default" style="background: green;">
						  Descargar PDF
						</a>

						<a href="{% url 'admin:report_generar_pdf' %}?group={{ group }}&year={{ year }}&month={{ month }}"
   class="button default" style="background: green;">Descargar tarjetas del grupo</a>
					{% endif %}
				{% endif %}
			{% endif %}
	    </div>
	    {% if request.user.username != 'admin' %}
	    <div class="block" id="bloqueo">
			  Acceso restringido para esta fecha y no podras editar
			</div>
			{% endif %}
	</div>
  </form>
  {% else %}
    <p style="margin-top: 20px;">Selecciona un grupo, mes y año para comenzar.</p>
  {% endif %}
</div>


  <style type="text/css">
  	/* Reducir el ancho de los inputs de texto */
	input[type="password"], 
	input[type="email"], 
	input[type="url"], 
	input[type="number"], 
	textarea {
	    width: 50% !important;  /* Ajusta el porcentaje según necesites */
	    max-width: 300px;       /* Máximo ancho opcional */
	}
	select {
		width: auto !important; 
	    max-width: 300px;       /* Máximo ancho opcional */
	    font-size: 12px;
	}

	/* Inputs de fechas y horas */
	input[type="date"], 
	input[type="time"], 
	input[type="datetime-local"] {
	    width: 200px !important;
	}

	@media (max-width: 640px) {
		input[type="text"], {
			width: 100%!important;
		}
		.submit-row {
			display: flex!important; flex-direction: column!important; gap: 10px!important;
		}
	    td, th {
	        padding: 2px;
	        font-size: 12px;
	        line-height: 14px;
	    }
	    thead th {
		    font-size: 10px;
		}
	}

	/* Eliminar el estilo nativo del checkbox */
input[type="checkbox"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid #ccc;
  border-radius: 3px;
  outline: none;
  cursor: pointer;
  position: relative;
  vertical-align: middle;
}

/* Checkbox marcado (no disabled) */
input[type="checkbox"]:checked {
  background-color: #4CAF50;
  border-color: #4CAF50;
}

/* Checkbox disabled (sin marcar) */
input[type="checkbox"]:disabled {
  background-color: #f0f8ff; /* Color azul claro de fondo */
  border-color: #4682b4 !important; /* Color azul del borde */
  cursor: not-allowed;
}

/* Checkbox disabled y marcado */
input[type="checkbox"]:disabled:checked {
  background-color: #1e90ff !important; /* Azul más intenso */
  border-color: #1e90ff !important;
  opacity: 0.8;
}

/* Checkmark personalizado */
input[type="checkbox"]:checked::before {
  content: "✓";
  position: absolute;
  color: white;
  font-size: 14px;
  left: 2px;
  top: -2px;
}

/* Checkmark para disabled */
input[type="checkbox"]:disabled:checked::before {
  color: rgba(255, 255, 255, 0.9);
}

.block {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* semitransparente */
      z-index: 9999;
      display: none; /* oculto por defecto */
      justify-content: center;
      color: white;
      backdrop-filter: blur(0.6px);
      padding-top: 18%;
      font-size: 20px;
    	text-align: center;
    }


.addnote {
        display: flex;
    align-items: center;
    justify-content: flex-end;
    text-align: center;
    height: 45px;
    width: 25px;
    font-size: 9px !important;
    color: #333;
    text-decoration: none;
    cursor: pointer;
    background-position: center top;
    line-height: 9px;
    float: right;
    padding-left: 9px!important;
}

.hide_note_tooltip {
    display: none;
    position: absolute;
    top: 5%; /* debajo del botón */
    left: -94%;
    transform: translateX(-50%);
    background: #fff;
    border: 2px solid #ccc!important;
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px 8px rgb(229 219 219 / 15%);
    z-index: 100;
    width: 180px;
}
  </style>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.admin-table tbody tr');

    rows.forEach(row => {
        const hoursInput = row.querySelector('input[type="number"][name^="hours_"]');
        const coursesInput = row.querySelector('input[type="number"][name^="courses_"]');
        const participatedCheckbox = row.querySelector('input[type="checkbox"][name^="participated_"]');
        const privilegeSelect = row.querySelector('select[name^="privilege_"]');

        // 1. Identificar checkboxes que vienen marcados desde BD
        const isFromDB = participatedCheckbox.checked &&
            (parseFloat(hoursInput.value) || 0) === 0 &&
            (parseFloat(coursesInput.value) || 0) === 0;

        // 2. Rastrear si el usuario modificó los valores
        let userModified = false;

        const updateCheckbox = () => {
            const hoursValue = parseFloat(hoursInput.value) || 0;
            const coursesValue = parseFloat(coursesInput.value) || 0;
            const hasValues = hoursValue > 0 || coursesValue > 0;

            const selectedOption = privilegeSelect.options[privilegeSelect.selectedIndex];
            const privilegeName = selectedOption.textContent.trim();

            // Detectar modificación del usuario
            if (!userModified) {
                const hoursChanged = hoursValue !== (parseFloat(hoursInput.defaultValue) || 0);
                const coursesChanged = coursesValue !== (parseFloat(coursesInput.defaultValue) || 0);
                userModified = hoursChanged || coursesChanged;
            }

            // 3. Lógica de actualización del checkbox
            if (userModified) {
                participatedCheckbox.checked = hasValues;
            }

						// 4. Manejo del estado disabled y envío POST
						const hiddenName = participatedCheckbox.name;
						let hiddenInput = row.querySelector(`input[type="hidden"][name="${hiddenName}"]`);

						if (hasValues) {
						    participatedCheckbox.disabled = true;

						    if (!hiddenInput) {
						        console.log('create hidden input');
						        hiddenInput = document.createElement('input');
						        hiddenInput.type = 'hidden';
						        hiddenInput.name = participatedCheckbox.name;
						        hiddenInput.value = participatedCheckbox.checked ? 'on' : 'off';
						        hiddenInput.dataset.generated = "true";
						        row.appendChild(hiddenInput);
						    } else {
						        // Si ya existe, actualiza su valor por si cambió el checkbox
						        hiddenInput.value = participatedCheckbox.checked ? 'on' : 'off';
						    }
						} else {
								if (privilegeName === '-') {
									participatedCheckbox.disabled = true;
								} else {
									participatedCheckbox.disabled = false;
								}
						    // Eliminar solo si fue generado automáticamente
						    if (hiddenInput && hiddenInput.dataset.generated === "true") {
						        hiddenInput.remove();
						    }
						}


            // 5. Estilos visuales
            participatedCheckbox.style.opacity = participatedCheckbox.disabled ? '0.7' : '1';
            participatedCheckbox.style.cursor = participatedCheckbox.disabled ? 'not-allowed' : 'pointer';
        };

        // 6. Función para manejar cambios en el select de privilegio
        const updateHoursReadonly = () => {
            const selectedOption = privilegeSelect.options[privilegeSelect.selectedIndex];
            const privilegeName = selectedOption.textContent.trim();

            if (privilegeName === 'Publicador') {
                hoursInput.readOnly = true;
                coursesInput.readOnly = false;
                participatedCheckbox.disabled = false;
                hoursInput.value = '';
            } else if (privilegeName === 'Auxiliar' || privilegeName === 'PR') {
                hoursInput.readOnly = false;
                coursesInput.readOnly = false;
                participatedCheckbox.disabled = false;
            } else if (privilegeName === '-') {
            	console.log(participatedCheckbox)
            	participatedCheckbox.disabled = true;
                // Reset inputs
                hoursInput.value = '';
                coursesInput.value = '';
                participatedCheckbox.checked = false;
                

                hoursInput.readOnly = true;
                coursesInput.readOnly = true;

                // Eliminar hidden correspondiente si fue creado automáticamente
                const hiddenInput = row.querySelector(`input[name="${participatedCheckbox.name}"]`);
                if (hiddenInput && hiddenInput.dataset.generated === "true") {
                    hiddenInput.remove();
                }
            }

            // Forzar evaluación después del cambio
            updateCheckbox();
        };

        // 7. Escuchar cambios en hours/courses
        ['input', 'change'].forEach(event => {
            hoursInput.addEventListener(event, () => {
                userModified = true;
                updateCheckbox();
            });
            coursesInput.addEventListener(event, () => {
                userModified = true;
                updateCheckbox();
            });
        });

        // 8. Escuchar cambios en privilege
        privilegeSelect.addEventListener('change', () => {
            updateHoursReadonly();

            // Asegurar que la opción quede seleccionada
            privilegeSelect.querySelectorAll('option').forEach(opt => opt.removeAttribute('selected'));
            privilegeSelect.options[privilegeSelect.selectedIndex].setAttribute('selected', 'selected');
        });

        // 9. Inicializar estado
        updateHoursReadonly();
        updateCheckbox();
    });

    // === Filtro por nombre ===
    const buscarInput = document.querySelector('input[name="buscar"]');
    const allRows = document.querySelectorAll('.admin-table tbody tr');

    if (buscarInput) {
        buscarInput.addEventListener('input', function () {
            const filtro = buscarInput.value.toLowerCase();
            allRows.forEach(row => {
                const nombreCelda = row.querySelector('td');
                const texto = nombreCelda?.textContent.toLowerCase() || '';
                row.style.display = texto.includes(filtro) ? '' : 'none';
            });
        });
    }




    const toggles = document.querySelectorAll('.addnote');

    toggles.forEach((toggle, i) => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const input = this.parentElement.querySelector('.hide_note_tooltip');
            if (input.style.display === 'block') {
                input.style.display = 'none';
            } else {
                // Ocultar otros tooltips si están abiertos
                document.querySelectorAll('.hide_note_tooltip').forEach(el => el.style.display = 'none');
                input.style.display = 'block';
                input.focus();
            }
        });
    });

    // Opcional: Ocultar si haces clic fuera
    document.addEventListener('click', function(e) {
        const clickedInside = e.target.closest('.hide_note_tooltip') || e.target.classList.contains('addnote');

		    if (!clickedInside) {
		        document.querySelectorAll('.hide_note_tooltip').forEach(el => {
		            el.style.display = 'none';
		        });
		    }
    });
});

const id_month = document.getElementById('id_month');
const id_year = document.getElementById('id_year');

// Reemplaza esta fecha con la que quieras comparar
const fechaAValidar = new Date(id_year.value + '-' + id_month.value);

// Obtener fecha actual y restar 2 meses
const hoy = new Date();
const limite_menor = new Date(hoy.getFullYear(), hoy.getMonth() - 1);
const limite_mayor = new Date(hoy.getFullYear(), hoy.getMonth() + 0);

// Comparar fechas
if (fechaAValidar < limite_menor) {
  const bloqueo = document.getElementById('bloqueo');
  bloqueo.style.display = 'flex';
}
if (fechaAValidar >= limite_mayor) {
  const bloqueo = document.getElementById('bloqueo');
  bloqueo.style.display = 'flex';
}
</script>
{% endblock %}
